# ─────────────────────────────────────────────────────────────
# modules/jenkins/values.yaml.tmpl
# ─────────────────────────────────────────────────────────────
controller:
  admin:                 # keep a simple admin login; change the pwd anytime
    username: admin
    password: admin123

  serviceType: LoadBalancer
  servicePort: 80
  targetPort: 8080

  resources:
    limits:   {cpu: "500m", memory: "1Gi"}
    requests: {cpu: "250m", memory: "512Mi"}

  installPlugins:
    - kubernetes:latest
    - workflow-aggregator:latest
    - git:latest
    - configuration-as-code:latest
    - credentials-binding:latest
    - github:latest
    - docker-plugin:latest
    - docker-workflow:latest
    - job-dsl:latest

  serviceAccount:
    name: jenkins-sa                 # SA is created elsewhere

  # ──────────────────────────────────────────────
  # Jenkins Configuration-as-Code (JCasC) section
  # ──────────────────────────────────────────────
  jcasc:
    enabled: true
    defaultConfig: true
    configScripts:
      credentials: |                 # <-- создаём github-token
        credentials:
          system:
            domainCredentials:
              - credentials:
                  - usernamePassword:
                      scope: GLOBAL
                      id: github-token
                      username: {{ .Values.github.user | quote }}
                      password: {{ .Values.github.pat  | quote }}
                      description: GitHub PAT injected by Terraform

      seed-job: |                   # <-- исправленный seed job
        jobs:
          script: >
            job('seed-job') {
              description('Job to generate pipeline for Django project')
              scm {
                git {
                  remote {
                    url('{{ .Values.github.repoUrl }}')
                    credentials('github-token')
                  }
                  branches('*/jenkins')
                }
              }
              steps {
                dsl {
                  text: |
                    pipelineJob("goit-django-docker") {
                      definition {
                        cpsScm {
                          scm {
                            git {
                              remote {
                                url('{{ .Values.github.repoUrl }}')
                                credentials("github-token")
                              }
                              branches("*/jenkins")
                            }
                          }
                        }
                      }
                    }
                }
              }
            }

# ─────────────────────────────────────────────────────────────
# EBS persistence
# ─────────────────────────────────────────────────────────────
persistence:
  enabled: true
  storageClass: ebs-sc
  size: 10Gi

# ─────────────────────────────────────────────────────────────
#  Variables that Terraform will fill in
# ─────────────────────────────────────────────────────────────
github:
  user:    ${github_user}
  pat:     ${github_pat}
  repoUrl: ${github_repo_url}
